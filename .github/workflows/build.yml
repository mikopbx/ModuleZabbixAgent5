name: Build and Publish

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:

jobs:
  build:
    uses: mikopbx/.github-workflows/.github/workflows/extension-publish.yml@master
    with:
      initial_version: "1.18"
      custom_build_steps: |
        cd $GITHUB_WORKSPACE/module
        rm -f bin/zabbix_agentd bin/zabbix_agentd_arm
        
        # Set up Docker cache
        DOCKER_IMAGE_TAG="zabbix-agent-builder"
        
        # Cache handling function
        handle_docker_cache() {
          local image_name=$1
          local dockerfile_path=$2
          local platforms=$3  # linux/amd64,linux/arm64
          local cache_prefix="$RUNNER_TEMP/docker-cache"
        
          # Build for each platform
          for platform in ${platforms//,/ }; do
            local arch=${platform#*/}  # Extract arch from platform
            local cache_file="${cache_prefix}-${image_name// /_}-${arch}.tar"
            local tagged_image="${image_name}-${arch}"
        
            # Try to restore from cache if cache exists and was hit
            if [ "$CACHE_HIT" = "true" ] && [ -f "$cache_file" ]; then
              echo "Loading cached image for $platform: $tagged_image"
              docker load < "$cache_file"
            else
              echo "Building image for $platform: $tagged_image"
              docker buildx build \
                --platform $platform \
                --tag $tagged_image \
                --load \
                -f "$dockerfile_path" .
        
              # Save to cache
              echo "Caching image for $platform: $tagged_image"
              docker save $tagged_image > "$cache_file"
            fi
          done
        }
        
        handle_docker_cache "$DOCKER_IMAGE_TAG" ".github/build/zabbix-agent-builder/Dockerfile" "linux/arm64,linux/amd64"
        
        # Build zabbix agent for arm64
      
        docker create --name zabbix_agent_arm64 "$DOCKER_IMAGE_TAG"-arm64v8
        docker cp zabbix_agent_arm64:/build/zabbix-6.0.0/src/zabbix_agent/zabbix_agentd bin/zabbix_agentd_arm
        docker rm zabbix_agent_arm64
        
        # Build zabbix agent for amd64
        docker create --name zabbix_agent_amd64 "$DOCKER_IMAGE_TAG"-amd64
        docker cp zabbix_agent_amd64:/build/zabbix-6.0.0/src/zabbix_agent/zabbix_agentd bin/zabbix_agentd
        docker rm zabbix_agent_amd64

    secrets: inherit